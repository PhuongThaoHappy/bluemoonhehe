<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống quản lý thu phí chung cư</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1a237e 0%, #3949ab 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 0 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #fff;
        }

        .nav-item i {
            width: 20px;
            margin-right: 10px;
        }

        .main-content {
            margin-left: 280px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #333;
        }

        .header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
        }

        .section-header h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .section-body {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card .label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .search-box:focus-within {
            border-color: #667eea;
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            padding: 5px 10px;
            font-size: 1rem;
            flex: 1;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .status-overdue {
            background: #fff3cd;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            overflow-y: auto;
        }

        .modal-body {
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 5px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h4 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #333;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .header {
                padding: 15px 20px;
            }

            .section-body {
                padding: 20px;
            }
        }
        .logout-link {
    color: #666;
    margin-left: 5px;
    text-decoration: none;
    transition: color 0.2s ease;
}

.logout-link:hover {
    color: black; /* Khi di chuột vào sẽ đổi thành đen */
}

    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>🏠 BuildingPay</h1>
            <p>Quản lý thu phí chung cư</p>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-section="dashboard">
                📊 Tổng quan
            </a>
            <a href="#" class="nav-item" data-section="residents">
                👥 Cư dân
            </a>
            <a href="#" class="nav-item" data-section="fees">
                💰 Quản lý phí
            </a>
            <a href="#" class="nav-item" data-section="payments">
                💳 Thanh toán
            </a>
            <a href="#" class="nav-item" data-section="reports">
                📈 Báo cáo
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="menu-toggle" id="menuToggle">☰</button>
                <h2 id="pageTitle">Tổng quan</h2>
            </div>
            <div class="user-info">
                <span>👤 {{ fullname }}</span>
                <span>|</span>
                <a href="{% url 'logout' %}" class="logout-link" onclick="return confirmLogout()">🚪 Đăng xuất</a>
            </div>
        </div>

        <!-- Dashboard Section -->
        <section class="content-section active" id="dashboard">
            <div class="section-header">
                <h3>📊 Tổng quan hệ thống</h3>
                <p>Thống kê tổng quan về tình hình thu phí chung cư</p>
            </div>
            <div class="section-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="totalResidents">{{ total_residents }}</div>
                        <div class="label">Tổng số cư dân</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="totalRevenue">${{ total_revenue }}</div>
                        <div class="label">Doanh thu tháng</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="paidCount">{{ paid_count }}</div>
                        <div class="label">Đã thanh toán</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="overdueCount">{{ unpaid_count }}</div>
                        <div class="label">Chưa thanh toán</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px; color: #333;">📈 Thống kê theo tháng</h4>
                        <p style="color: #666;">Doanh thu tháng này: <strong style="color: #28a745;">${{ total_revenue }}</strong></p>
                        <p style="color: #666;">
                            So với tháng trước:
                            {% if change_percent is not None %}
                                {% if change_percent >= 0 %}
                                    <strong style="color: #28a745;">+{{ change_percent|floatformat:1 }}%</strong>
                                {% else %}
                                    <strong style="color: red;">{{ change_percent|floatformat:1 }}%</strong>
                                {% endif %}
                            {% else %}
                            <strong>Không có dữ liệu tháng trước</strong>
                            {% endif %}
                        </p>
                        <p style="color: #666;">
                        Tỷ lệ thu:
                        {% if collection_rate is not None %}
                        <strong style="color: #17a2b8;">{{ collection_rate|floatformat:1 }}%</strong>
                        {% else %}
                        <strong>Không có dữ liệu</strong>
                        {% endif %}
                        </p>
                    </div>
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px; color: #333;">⚠️ Cần chú ý</h4>
                        <p style="color: #666;">Hóa đơn quá hạn: <strong style="color: #dc3545;">{{ overdue_bills }} hóa đơn</strong></p>
                        <p style="color: #666;">Tổng nợ: 
                            {% if total_debt %}
                            <strong style="color: #dc3545;">${{ total_debt|floatformat:0 }}</strong>
                            {% else %}
                            <strong style="color: #dc3545;">$0</strong>
                            {% endif %}
                        </p>
                        <p style="color: #666;">Cần liên hệ: 
                            <strong style="color: #ffc107;">
                            {{ need_contact_count }} cư dân
                            </strong>
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Residents Section -->
        <section class="content-section" id="residents">
    <div class="section-header">
        <h3>👥 Quản lý cư dân</h3>
        <p>Danh sách và thông tin các cư dân trong chung cư</p>
    </div>
    <div class="section-body">
        <div class="controls">
            <div class="search-box">
                <input type="text" id="residentSearch" placeholder="🔍 Tìm kiếm cư dân...">
            </div>   

        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Họ tên</th>
                        <th>Giới tính</th>
                        <th>Tên khác</th>
                        <th>Ngày sinh</th>
                        <th>Nơi sinh</th>
                        <th>Nguyên quán</th>
                        <th>Dân tộc</th>
                        <th>Nghề nghiệp</th>
                        <th>Nơi làm việc</th>
                        <th>Số CCCD</th>
                        <th>Ngày cấp</th>
                        <th>Nơi cấp</th>
                        <th>Quan hệ với chủ hộ</th>
                        <th>Tạm trú</th>
                        <th>Ghi chú</th>
                        <th>Ngày nhập hộ</th>
                    </tr>
                </thead>
    <tbody id="residentsTable">
        {% for member in members %}
        <tr>
            <td>{{ member.full_name }}</td>
            <td>{{ member.get_gender_display }}</td>
            <td>{{ member.other_name }}</td>
            <td>{{ member.dob }}</td>
            <td>{{ member.place_of_birth }}</td>
            <td>{{ member.native_place }}</td>
            <td>{{ member.ethnic_group }}</td>
            <td>{{ member.occupation }}</td>
            <td>{{ member.place_of_work }}</td>
            <td>{{ member.cccd }}</td>
            <td>{{ member.issue_date }}</td>
            <td>{{ member.issued_by }}</td>
            <td>{{ member.relationship }}</td>
            <td>{% if member.is_temporary %}Có{% else %}Không{% endif %}</td>
            <td>{{ member.note }}</td>
            <td>{{ member.joined_at }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="16">Không có thành viên nào</td>
        </tr>
        {% endfor %}
                </tbody>
</table>

        </div>
    </div>
</section>

        <!-- Fees Section -->
        <section class="content-section" id="fees">
            <div class="section-header">
                <h3>💰 Quản lý phí</h3>
                <p>Thiết lập và quản lý các loại phí chung cư</p>
            </div>
            <div class="section-body">
                <div class="controls">
                    <div class="search-box">
                        <input type="text" id="feeSearch" placeholder="🔍 Tìm kiếm loại phí...">
                    </div>
                    <button class="btn btn-primary" onclick="openFeeModal()">
                        ➕ Thêm loại phí mới
                    </button>
                </div>

                <div class="table-container">
                    <table>
    <thead>
        <tr>
            <th>Tên phí</th>
            <th>Số tiền</th>
            <th>Loại</th>
            <th>Hạn thanh toán</th>
            <th>Mô tả</th>
            <th>Phí chung</th> <!-- thêm cột mới -->
            <th>Người tạo</th>
            <th>Ngày tạo</th>
        </tr>
    </thead>
    <tbody id="feesTable">
        {% for fee in fees %}
            <tr>
                <td>{{ fee.title }}</td>
                <td>{{ fee.amount }}</td>
                <td>{{ fee.get_type_display }}</td>
                <td>{{ fee.due_date }}</td>
                <td>{{ fee.description }}</td>
                <td>{% if fee.is_common %}Y{% else %}N{% endif %}</td> <!-- giá trị phí chung -->
                <td>{{ fee.created_by.fullname }}</td>
                <td>{{ fee.created_at }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="8">Không có khoản phí nào</td> <!-- sửa colspan = 8 -->
            </tr>
        {% endfor %}
    </tbody> 
</table>

                </div>
            </div>
        </section>

        <!-- Payments Section -->
        <section class="content-section" id="payments">
            <div class="section-header">
                <h3>💳 Quản lý thanh toán</h3>
                <p>Theo dõi các khoản thu và chi trong chung cư</p>
            </div>
            <div class="section-body">
                <div class="controls">
                    <div class="search-box">
                        <input type="text" id="paymentSearch" placeholder="🔍 Tìm kiếm giao dịch...">
                    </div>
                    <button class="btn btn-primary" onclick="openPaymentModal()">
                        ➕ Thêm giao dịch mới
                    </button>
                </div>

                <div class="table-container">
                    <div class="controls">
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Ngày thanh toán</th>
                <th>Căn hộ</th>
                <th>Loại phí</th>
                <th>Số tiền</th>
                <th>Trạng thái</th>
                <th>Phương thức</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="paymentsTable">
            {% for payment in payments %}
            <tr>
                <td>{{ payment.paid_at|date:"d/m/Y H:i" }}</td>
                <td>{{ payment.household.household_number }}</td>
                <td>{{ payment.fee.title }}</td>
                <td>{{ payment.fee.amount|floatformat:0 }}</td>
                <td>{{ payment.get_status_display }}</td>
                <td>{{ payment.get_method_display }}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" onclick="openPaymentEditModal('{{ payment.id }}', '{{ payment.paid_at|date:"Y-m-d\\TH:i" }}', '{{ payment.status }}', '{{ payment.method }}')">
    Sửa
</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">Không có giao dịch nào</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section class="content-section" id="reports">
            <div class="section-header">
                <h3>📈 Báo cáo thống kê</h3>
                <p>Báo cáo chi tiết về tình hình thu phí</p>
            </div>
            <div class="section-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
    <h4 style="margin-bottom: 20px; color: #333;">📊 Báo cáo tháng</h4>
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Chọn tháng:</label>
        <input type="month" id="reportMonth" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
    </div>
    <button class="btn btn-primary" style="width: 100%;" onclick="exportReport()">Xuất báo cáo</button>
</div>


                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
    <h4 style="margin-bottom: 20px; color: #333;">📋 Danh sách nợ</h4>
    <p style="color: #666; margin-bottom: 15px;">Xuất danh sách các hộ gia đình còn nợ phí</p>
    <button class="btn btn-warning" style="width: 100%;" onclick="exportDebtList()">Xuất danh sách nợ</button>
</div>

                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4 style="margin-bottom: 5px; color: #333;">💰 Báo cáo doanh thu</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <p style="color: #666;">Doanh thu tháng này: <strong style="color: #28a745;">${{ total_revenue }}</strong></p>
                        <p style="color: #666;">
                            So với tháng trước:
                            {% if change_percent is not None %}
                                {% if change_percent >= 0 %}
                                    <strong style="color: #28a745;">+{{ change_percent|floatformat:1 }}%</strong>
                                {% else %}
                                    <strong style="color: red;">{{ change_percent|floatformat:1 }}%</strong>
                                {% endif %}
                            {% else %}
                            <strong>Không có dữ liệu tháng trước</strong>
                            {% endif %}
                        </p>
                        <p style="color: #666;">
                        Tỷ lệ thu:
                        {% if collection_rate is not None %}
                        <strong style="color: #17a2b8;">{{ collection_rate|floatformat:1 }}%</strong>
                        {% else %}
                        <strong>Không có dữ liệu</strong>
                        {% endif %}
                        </p>
                    </div>
                    </div>
                </div>

                <div style="margin-top: 30px; background: #f8f9fa; padding: 25px; border-radius: 10px;">
                    <h4 style="margin-bottom: 20px; color: #333;">📈 Biểu đồ thống kê tháng này</h4>
                    <div style="height: 100%; width: 100%; background: white; border-radius: 10px; padding: 20px;">
    <canvas id="revenuePieChart" style="width: 100%; height: 100%;"></canvas>
</div>
            </div>
        </section>
    </div>

    <!-- Fee Modal -->
    <div id="feeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="feeModalTitle">Thêm loại phí mới</h3>
                <span class="close" onclick="closeModal('feeModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="feeForm">
    {% csrf_token %}
    <div class="form-group">
        <label for="feeName">Tên phí *</label>
        <input type="text" id="feeName" name="title" required>
    </div>
    <div class="form-group">
        <label for="feeAmount">Mức phí *</label>
        <input type="number" id="feeAmount" name="amount" required step="1">
    </div>
    <div class="form-group">
        <label for="feeUnit">Loại phí *</label>
        <select id="feeUnit" name="type" required>
            <option value="voluntary">Voluntary</option>
            <option value="mandatory">Mandatory</option>
        </select>
    </div>
    <div class="form-group">
        <label for="feeDueDate">Hạn đóng *</label>
        <input type="date" id="feeDueDate" name="due_date" required>
    </div>
    <div class="form-group">
        <label for="feeDescription">Mô tả</label>
        <textarea id="feeDescription" name="description" rows="3"></textarea>
    </div>
    <div class="form-group">
    <label for="isCommon">Là phí chung?</label>
    <select id="isCommon" name="is_common" required onchange="toggleHouseholdSelect(this.value)">
        <option value="true" selected>Có</option>
        <option value="false">Không</option>
    </select>
</div>

<div class="form-group" id="householdSelectGroup" style="display: none;">
    <label for="households">Chọn hộ áp dụng (nếu không phải phí chung)</label>
    <select id="households" name="households" multiple>
        {% for household in households %}
            <option value="{{ household.id }}">{{ household.household_number }}</option>
        {% endfor %}
    </select>
</div>

    <div class="form-group">
        <label for="feeStatus">Trạng thái</label>
        <select id="feeStatus" name="status">
            <option value="active">Áp dụng</option>
            <option value="inactive">Tạm dừng</option>
        </select>
    </div>
    <div class="form-actions">
        <button type="button" class="btn" onclick="closeModal('feeModal')">Hủy</button>
        <button type="submit" class="btn btn-success">Lưu</button>
    </div>
</form>

            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="editPaymentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chỉnh sửa giao dịch</h3>
            <span class="close" onclick="closeModal('editPaymentModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editPaymentForm" method="POST" onsubmit="submitEditForm(event)">
    {% csrf_token %}
    <input type="hidden" id="editPaymentId" name="payment_id">

    <div class="form-group">
        <label for="editPaidAt">Ngày thanh toán</label>
        <input type="datetime-local" id="editPaidAt" name="paid_at">
    </div>

    <div class="form-group">
        <label for="editStatus">Trạng thái</label>
        <select id="editStatus" name="status">
            <option value="unpaid">Chưa nộp</option>
            <option value="paid">Đã nộp</option>
        </select>
    </div>

    <div class="form-group">
        <label for="editMethod">Phương thức</label>
        <select id="editMethod" name="method">
            <option value="cash">Tiền mặt</option>
            <option value="card">Thẻ</option>
            <option value="qr_code">QR</option>
        </select>
    </div>

    <div class="form-actions">
        <button type="button" onclick="closeModal('editPaymentModal')" class="btn">Hủy</button>
        <button type="submit" class="btn btn-success">Lưu thay đổi</button>
    </div>
</form>


        </div>
    </div>
</div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="paymentModalTitle">Thêm giao dịch mới</h3>
                <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
    {% csrf_token %}
    <div class="form-group">
        <label for="paymentDate">Ngày thanh toán *</label>
        <input type="datetime-local" id="paymentDate" name="paid_at" required>
    </div>

    <div class="form-group">
        <label for="paymentHousehold">Hộ gia đình *</label>
        <select id="paymentHousehold" name="household" required>
            <option value="">Chọn hộ</option>
            {% for household in households %}
            <option value="{{ household.id }}">{{ household.household_number }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="paymentFee">Loại phí *</label>
        <select id="paymentFee" name="fee" required>
            <option value="">Chọn loại phí</option>
            {% for fee in fees %}
            <option value="{{ fee.id }}">{{ fee.title }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="paymentMethod">Phương thức *</label>
        <select id="paymentMethod" name="method" required>
            <option value="cash">Tiền mặt</option>
            <option value="bank_transfer">Chuyển khoản</option>
        </select>
    </div>

    <div class="form-group">
        <label for="paymentStatus">Trạng thái *</label>
        <select id="paymentStatus" name="status" required>
            <option value="paid">Đã thanh toán</option>
            <option value="unpaid">Chưa thanh toán</option>
            <option value="overdue">Quá hạn</option>
        </select>
    </div>

    <div class="form-actions">
        <button type="button" class="btn" onclick="closeModal('paymentModal')">Hủy</button>
        <button type="submit" class="btn btn-success">Lưu</button>
    </div>
</form>

            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let residents = [
            {
                id: 1,
                apartmentNumber: "A101",
                ownerName: "Nguyễn Văn An",
                phone: "0901234567",
                area: 75.5,
                email: "an.nguyen@email.com",
                status: "active"
            },
            {
                id: 2,
                apartmentNumber: "A102",
                ownerName: "Trần Thị Bình",
                phone: "0912345678",
                area: 82.0,
                email: "binh.tran@email.com",
                status: "active"
            },
            {
                id: 3,
                apartmentNumber: "B203",
                ownerName: "Lê Văn Cường",
                phone: "0923456789",
                area: 95.5,
                email: "cuong.le@email.com",
                status: "inactive"
            }
        ];

        let fees = [
            {
                id: 1,
                name: "Phí quản lý",
                amount: 15000,
                unit: "per_m2",
                description: "Phí quản lý chung cư hàng tháng",
                status: "active"
            },
            {
                id: 2,
                name: "Phí gửi xe máy",
                amount: 150000,
                unit: "per_month",
                description: "Phí gửi xe máy trong tầng hầm",
                status: "active"
            },
            {
                id: 3,
                name: "Phí nước",
                amount: 25000,
                unit: "per_m2",
                description: "Phí nước sinh hoạt",
                status: "active"
            }
        ];

        let payments = [
            {
                id: 1,
                date: "2024-01-15",
                apartmentId: 1,
                feeId: 1,
                amount: 1132500,
                status: "paid",
                note: "Thanh toán đầy đủ"
            },
            {
                id: 2,
                date: "2024-01-10",
                apartmentId: 2,
                feeId: 1,
                amount: 1230000,
                status: "paid",
                note: ""
            },
            {
                id: 3,
                date: "2024-01-05",
                apartmentId: 3,
                feeId: 2,
                amount: 150000,
                status: "overdue",
                note: "Quá hạn 15 ngày"
            }
        ];

        let editingId = null;
        let editingType = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateCurrentDate();
            //renderAllData();
            //updateDashboardStats();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Menu toggle for mobile
            document.getElementById('menuToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('open');
            });

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                    
                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update page title
                    const titles = {
                        dashboard: 'Tổng quan',
                        residents: 'Cư dân',
                        fees: 'Quản lý phí',
                        payments: 'Thanh toán',
                        reports: 'Báo cáo'
                    };
                    document.getElementById('pageTitle').textContent = titles[section];
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });
            });

            // Search functionality: lọc dữ liệu khi nhập, không submit form, không reload trang
            document.getElementById('residentSearch').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#residentsTable tr');

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const match = Array.from(cells).some(cell =>
            cell.textContent.toLowerCase().includes(filter)
        );
        row.style.display = match ? '' : 'none';
    });
});

            document.getElementById('feeSearch').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#feesTable tr');

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const match = Array.from(cells).some(cell =>
            cell.textContent.toLowerCase().includes(filter)
        );
        row.style.display = match ? '' : 'none';
    });
});

            document.getElementById('paymentSearch').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#paymentsTable tr');

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const match = Array.from(cells).some(cell =>
            cell.textContent.toLowerCase().includes(filter)
        );
        row.style.display = match ? '' : 'none';
    });
});


            // Chặn submit mặc định khi nhấn Enter trong các form tìm kiếm (nếu input nằm trong form)
            ['residentForm', 'paymentForm'].forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    form.addEventListener('submit', function(event) {
                        event.preventDefault();  // Chặn reload trang khi submit form
                        // Sau khi chặn, bạn gọi hàm xử lý submit tương ứng nếu muốn
                        // Ví dụ:
                        if (formId === 'residentForm') saveResident(event);
                        //else if (formId === 'feeForm') saveFee(event);
                        else if (formId === 'paymentForm') savePayment(event);
                    });
                }
            });

            // Modal close on outside click
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Show specific section
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');
        }

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        // Update dashboard statistics
        // function updateDashboardStats() {
        //     document.getElementById('totalResidents').textContent = residents.length;
            
        //     const totalRevenue = payments
        //         .filter(p => p.status === 'paid')
        //         .reduce((sum, p) => sum + p.amount, 0);
        //     document.getElementById('totalRevenue').textContent = (totalRevenue / 1000000).toFixed(1) + 'M';
            
        //     document.getElementById('paidCount').textContent = payments.filter(p => p.status === 'paid').length;
        //     document.getElementById('overdueCount').textContent = payments.filter(p => p.status === 'overdue').length;
        // }

        // Render all data
        // function renderAllData() {
        //     // renderResidents();
        //     renderFees();
        //     renderPayments();
        //     //populateSelectOptions();
        // }

        // Render residents table
        // function renderResidents(data = residents) {
        //     const tbody = document.getElementById('residentsTable');
        //     tbody.innerHTML = data.map(resident => `
        //         <tr>
        //             <td><strong>${resident.apartmentNumber}</strong></td>
        //             <td>${resident.ownerName}</td>
        //             <td>${resident.phone || 'Chưa có'}</td>
        //             <td>${resident.area ? resident.area + ' m²' : 'Chưa có'}</td>
        //             <td>
        //                 <span class="status-badge ${resident.status === 'active' ? 'status-paid' : 'status-unpaid'}">
        //                     ${resident.status === 'active' ? '🟢 Đang ở' : '⭕ Tạm vắng'}
        //                 </span>
        //             </td>
        //             <td>
        //                 <button class="btn btn-warning" style="padding: 8px 15px; margin-right: 5px;" onclick="editResident(${resident.id})">
        //                     ✏️ Sửa
        //                 </button>
        //                 <button class="btn btn-danger" style="padding: 8px 15px;" onclick="deleteResident(${resident.id})">
        //                     🗑️ Xóa
        //                 </button>
        //             </td>
        //         </tr>
        //     `).join('');
        // }

        // Render fees table
        // function renderFees(data = fees) {
        //     const tbody = document.getElementById('feesTable');
        //     tbody.innerHTML = data.map(fee => `
        //         <tr>
        //             <td><strong>${fee.name}</strong></td>
        //             <td>${formatCurrency(fee.amount)}</td>
        //             <td>${getFeeUnitText(fee.unit)}</td>
        //             <td>${fee.description || 'Không có mô tả'}</td>
        //             <td>
        //                 <span class="status-badge ${fee.status === 'active' ? 'status-paid' : 'status-unpaid'}">
        //                     ${fee.status === 'active' ? '🟢 Áp dụng' : '⭕ Tạm dừng'}
        //                 </span>
        //             </td>
        //             <td>
        //                 <button class="btn btn-warning" style="padding: 8px 15px; margin-right: 5px;" onclick="editFee(${fee.id})">
        //                     ✏️ Sửa
        //                 </button>
        //                 <button class="btn btn-danger" style="padding: 8px 15px;" onclick="deleteFee(${fee.id})">
        //                     🗑️ Xóa
        //                 </button>
        //             </td>
        //         </tr>
        //     `).join('');
        // }

        // // Render payments table
        // function renderPayments(data = payments) {
        //     const tbody = document.getElementById('paymentsTable');
        //     tbody.innerHTML = data.map(payment => {
        //         const resident = residents.find(r => r.id === payment.apartmentId);
        //         const fee = fees.find(f => f.id === payment.feeId);
                
        //         return `
        //             <tr>
        //                 <td>${formatDate(payment.date)}</td>
        //                 <td>${resident ? resident.apartmentNumber : 'N/A'}</td>
        //                 <td>${fee ? fee.name : 'N/A'}</td>
        //                 <td>${formatCurrency(payment.amount)}</td>
        //                 <td>
        //                     <span class="status-badge ${getPaymentStatusClass(payment.status)}">
        //                         ${getPaymentStatusText(payment.status)}
        //                     </span>
        //                 </td>
        //                 <td>${payment.note || 'Không có'}</td>
        //                 <td>
        //                     <button class="btn btn-warning" style="padding: 8px 15px; margin-right: 5px;" onclick="editPayment(${payment.id})">
        //                         ✏️ Sửa
        //                     </button>
        //                     <button class="btn btn-danger" style="padding: 8px 15px;" onclick="deletePayment(${payment.id})">
        //                         🗑️ Xóa
        //                     </button>
        //                 </td>
        //             </tr>
        //         `;
        //     }).join('');
        // }

        // Populate select options
        // function populateSelectOptions() {
        //     const apartmentSelect = document.getElementById('paymentApartment');
        //     apartmentSelect.innerHTML = '<option value="">Chọn căn hộ</option>' +
        //         residents.map(r => `<option value="${r.id}">${r.apartmentNumber} - ${r.ownerName}</option>`).join('');

        //     const feeSelect = document.getElementById('paymentFeeType');
        //     feeSelect.innerHTML = '<option value="">Chọn loại phí</option>' +
        //         fees.filter(f => f.status === 'active').map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        // }

        // Filter functions
        function filterResidents(searchTerm) {
            const filtered = residents.filter(r => 
                r.apartmentNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                r.ownerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (r.phone && r.phone.includes(searchTerm))
            );
            // renderResidents(filtered);
        }

        function filterFees(searchTerm) {
            const filtered = fees.filter(f => 
                f.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (f.description && f.description.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            renderFees(filtered);
        }

        function filterPayments(searchTerm) {
            const filtered = payments.filter(p => {
                const resident = residents.find(r => r.id === p.apartmentId);
                const fee = fees.find(f => f.id === p.feeId);
                return (resident && resident.apartmentNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
                       (fee && fee.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                       (p.note && p.note.toLowerCase().includes(searchTerm.toLowerCase()));
            });
            renderPayments(filtered);
        }

        // Modal functions
        function openFeeModal() {
            document.getElementById('feeModal').style.display = 'block';
            document.getElementById('feeModalTitle').textContent = 'Thêm loại phí mới';
            //document.getElementById('feeForm').reset();
            editingId = null;
            editingType = 'fee';
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').style.display = 'block';
            document.getElementById('paymentModalTitle').textContent = 'Thêm giao dịch mới';
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            editingId = null;
            editingType = 'payment';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingId = null;
            editingType = null;
        }

        // Save functions
        // function saveResident(e) {
        //     e.preventDefault();
            
        //     const formData = {
        //         apartmentNumber: document.getElementById('apartmentNumber').value,
        //         ownerName: document.getElementById('ownerName').value,
        //         phone: document.getElementById('phone').value,
        //         area: parseFloat(document.getElementById('area').value) || 0,
        //         email: document.getElementById('email').value,
        //         status: document.getElementById('residentStatus').value
        //     };

        //     if (editingId) {
        //         const index = residents.findIndex(r => r.id === editingId);
        //         residents[index] = { ...residents[index], ...formData };
        //     } else {
        //         const newId = Math.max(...residents.map(r => r.id), 0) + 1;
        //         residents.push({ id: newId, ...formData });
        //     }

        //     // renderResidents();
        //     populateSelectOptions();
        //     updateDashboardStats();
        //     closeModal('residentModal');
        // }

        // function saveFee(e) {
        //     e.preventDefault();
            
        //     const formData = {
        //         name: document.getElementById('feeName').value,
        //         amount: parseInt(document.getElementById('feeAmount').value),
        //         unit: document.getElementById('feeUnit').value,
        //         description: document.getElementById('feeDescription').value,
        //         status: document.getElementById('feeStatus').value
        //     };

        //     if (editingId) {
        //         const index = fees.findIndex(f => f.id === editingId);
        //         fees[index] = { ...fees[index], ...formData };
        //     } else {
        //         const newId = Math.max(...fees.map(f => f.id), 0) + 1;
        //         fees.push({ id: newId, ...formData });
        //     }

        //     renderFees();
        //     //populateSelectOptions();
        //     closeModal('feeModal');
        // }

        // function savePayment(e) {
        //     e.preventDefault();
            
        //     const formData = {
        //         date: document.getElementById('paymentDate').value,
        //         apartmentId: parseInt(document.getElementById('paymentApartment').value),
        //         feeId: parseInt(document.getElementById('paymentFeeType').value),
        //         amount: parseInt(document.getElementById('paymentAmount').value),
        //         status: document.getElementById('paymentStatus').value,
        //         note: document.getElementById('paymentNote').value
        //     };

        //     if (editingId) {
        //         const index = payments.findIndex(p => p.id === editingId);
        //         payments[index] = { ...payments[index], ...formData };
        //     } else {
        //         const newId = Math.max(...payments.map(p => p.id), 0) + 1;
        //         payments.push({ id: newId, ...formData });
        //     }

        //     renderPayments();
        //     updateDashboardStats();
        //     closeModal('paymentModal');
        // }

        // Edit functions
        // function editResident(id) {
        //     const resident = residents.find(r => r.id === id);
        //     if (!resident) return;

        //     document.getElementById('apartmentNumber').value = resident.apartmentNumber;
        //     document.getElementById('ownerName').value = resident.ownerName;
        //     document.getElementById('phone').value = resident.phone || '';
        //     document.getElementById('area').value = resident.area || '';
        //     document.getElementById('email').value = resident.email || '';
        //     document.getElementById('residentStatus').value = resident.status;

        //     document.getElementById('residentModalTitle').textContent = 'Chỉnh sửa cư dân';
        //     document.getElementById('residentModal').style.display = 'block';
        //     editingId = id;
        //     editingType = 'resident';
        // }

        // function editFee(id) {
        //     const fee = fees.find(f => f.id === id);
        //     if (!fee) return;

        //     document.getElementById('feeName').value = fee.name;
        //     document.getElementById('feeAmount').value = fee.amount;
        //     document.getElementById('feeUnit').value = fee.unit;
        //     document.getElementById('feeDescription').value = fee.description || '';
        //     document.getElementById('feeStatus').value = fee.status;

        //     document.getElementById('feeModalTitle').textContent = 'Chỉnh sửa loại phí';
        //     document.getElementById('feeModal').style.display = 'block';
        //     editingId = id;
        //     editingType = 'fee';
        // }

        // function editPayment(id) {
        //     const payment = payments.find(p => p.id === id);
        //     if (!payment) return;

        //     document.getElementById('paymentDate').value = payment.date;
        //     //document.getElementById('paymentApartment').value = payment.apartmentId;
        //     document.getElementById('paymentFeeType').value = payment.feeId;
        //     document.getElementById('paymentAmount').value = payment.amount;
        //     document.getElementById('paymentStatus').value = payment.status;
        //     document.getElementById('paymentNote').value = payment.note || '';

        //     document.getElementById('paymentModalTitle').textContent = 'Chỉnh sửa giao dịch';
        //     document.getElementById('paymentModal').style.display = 'block';
        //     editingId = id;
        //     editingType = 'payment';
        // }

        // Delete functions
        // function deleteResident(id) {
        //     if (confirm('Bạn có chắc chắn muốn xóa cư dân này?')) {
        //         residents = residents.filter(r => r.id !== id);
        //         // renderResidents();
        //         //populateSelectOptions();
        //         updateDashboardStats();
        //     }
        // }

        // function deleteFee(id) {
        //     if (confirm('Bạn có chắc chắn muốn xóa loại phí này?')) {
        //         fees = fees.filter(f => f.id !== id);
        //         renderFees();
        //         //populateSelectOptions();
        //     }
        // }

        // function deletePayment(id) {
        //     if (confirm('Bạn có chắc chắn muốn xóa giao dịch này?')) {
        //         payments = payments.filter(p => p.id !== id);
        //         renderPayments();
        //         updateDashboardStats();
        //     }
        // }

        // // Utility functions
        // function formatCurrency(amount) {
        //     return new Intl.NumberFormat('vi-VN', {
        //         style: 'currency',
        //         currency: 'VND'
        //     }).format(amount);
        // }

        // function formatDate(dateString) {
        //     return new Date(dateString).toLocaleDateString('vi-VN');
        // }

        // function getFeeUnitText(unit) {
        //     const units = {
        //         'per_month': 'Tháng',
        //         'per_m2': 'm²',
        //         'per_person': 'Người',
        //         'fixed': 'Cố định'
        //     };
        //     return units[unit] || unit;
        // }

        // function getPaymentStatusClass(status) {
        //     const classes = {
        //         'paid': 'status-paid',
        //         'unpaid': 'status-unpaid',
        //         'overdue': 'status-overdue'
        //     };
        //     return classes[status] || 'status-unpaid';
        // }

        // function getPaymentStatusText(status) {
        //     const texts = {
        //         'paid': '🟢 Đã thanh toán',
        //         'unpaid': '⭕ Chưa thanh toán',
        //         'overdue': '🔴 Quá hạn'
        //     };
        //     return texts[status] || status;
        // }

    function toggleHouseholdSelect(value) {
    const group = document.getElementById('householdSelectGroup');
    group.style.display = value === 'false' ? 'block' : 'none';
}

    document.getElementById('feeForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const formData = new FormData(this);

    fetch('', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(async res => {
        const contentType = res.headers.get("content-type");
        if (!res.ok) throw new Error("Server trả lỗi");

        if (contentType && contentType.includes("application/json")) {
            return res.json();
        } else {
            throw new Error("Phản hồi không phải JSON");
        }
    })
    .then(data => {
        if (data.success) {
            alert('✔️ Thêm loại phí thành công!');
            closeModal('feeModal');
            document.getElementById('feeForm').reset();

            const tableBody = document.getElementById('feesTable');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${data.title}</td>
                <td>${parseFloat(data.amount).toFixed(2)}</td>
                <td>${data.type}</td>
                <td>${data.due_date}</td>
                <td>${data.description || ''}</td>
                <td>${document.querySelector('#currentUsername')?.textContent || 'Bạn'}</td>
                <td>${new Date().toLocaleString()}</td>
            `;
            tableBody.appendChild(newRow);
        } else {
            alert('❌ Dữ liệu không hợp lệ');
            console.error(data.errors);
        }
    })
    .catch(err => {
        alert('❌ Không thể thêm loại phí: ' + err.message);
        console.error(err);
    });
});

   
function exportReport() {
    const monthInput = document.getElementById("reportMonth").value;
    if (!monthInput) {
        alert("Vui lòng chọn tháng");
        return;
    }

    fetch(`/ketoan/?month=${monthInput}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error("Không thể xuất báo cáo");
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bao_cao_phi_${monthInput}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    })
    .catch(err => {
        alert("❌ Xuất báo cáo thất bại!");
        console.error(err);
    });
}

function exportDebtList() {
    fetch('/ketoan/?debt=1', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Không thể xuất danh sách nợ');
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `danh_sach_no.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    })
    .catch(err => {
        alert('❌ Xuất thất bại!');
        console.error(err);
    });
}

function editPayment(paymentId) {
    // Fetch payment data (có thể là từ biến hoặc gọi API nếu cần)
    const row = document.querySelector(`button[onclick="editPayment('${paymentId}')"]`).closest('tr');
    
    // Gán các giá trị vào form
    document.getElementById('editPaymentId').value = paymentId;
    document.getElementById('editPaidAt').value = toDatetimeLocal(row.cells[0].innerText);
    document.getElementById('editMethod').value = row.cells[5].innerText.trim().toLowerCase();
    document.getElementById('editStatus').value = row.cells[4].innerText.trim().toLowerCase();

    // Hiện modal
    document.getElementById('editPaymentModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function toDatetimeLocal(datetimeStr) {
    // Chuyển định dạng d/m/Y H:i -> yyyy-MM-ddTHH:mm cho input datetime-local
    const [date, time] = datetimeStr.split(" ");
    const [day, month, year] = date.split("/");
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time}`;
}
function openPaymentEditModal(paymentId, paidAt, status, method) {
    document.getElementById("editPaymentId").value = paymentId;
    document.getElementById("editPaidAt").value = paidAt;
    document.getElementById("editStatus").value = status;
    document.getElementById("editMethod").value = method;
    document.getElementById("editPaymentModal").style.display = "block";
}

function submitEditForm(event) {
    event.preventDefault();

    const payment_id = document.getElementById("editPaymentId").value;
    const paid_at = document.getElementById("editPaidAt").value;
    const status = document.getElementById("editStatus").value;
    const method = document.getElementById("editMethod").value;
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    fetch("/update_payment/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
            payment_id: payment_id,
            paid_at: paid_at,
            status: status,
            method: method
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Cập nhật thành công!");
            closeModal('editPaymentModal');
            // Cập nhật lại bảng hoặc dữ liệu nếu cần
        } else {
            alert("Cập nhật thất bại: " + data.error);
        }
    })
    .catch(error => {
        alert("Lỗi mạng hoặc server");
        console.error(error);
    });
}


function formatDatetime(datetimeString) {
    const date = new Date(datetimeString);
    return date.toLocaleString("vi-VN");
}

function getMethodDisplay(method) {
    switch(method) {
        case 'cash': return 'Cash';
        case 'card': return 'Card';
        case 'qr_code': return 'QR';
        default: return method;
    }
}

document.addEventListener("DOMContentLoaded", function() {
    const fixedColors = [
        "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF",
        "#FF9F40", "#C9CBCF", "#B4E197", "#FF6B6B", "#6C5B7B",
        "#355C7D", "#F67280", "#F8B195", "#C06C84", "#6C567B",
        "#E1B12C", "#0097E6", "#44BD32", "#8C7AE6", "#E84118"
    ];

    fetch("/revenue_pie_data/")
        .then(response => response.json())
        .then(data => {
            const labels = data.map(item => item.title);
            const values = data.map(item => item.value);
            const backgroundColors = fixedColors.slice(0, labels.length);

            const ctx = document.getElementById('revenuePieChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tỉ lệ doanh thu',
                        data: values,
                        backgroundColor: backgroundColors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 20,
                                padding: 15,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error("Lỗi khi tải dữ liệu biểu đồ:", error);
        });
});

function confirmLogout() {
    return confirm("Đăng xuất khỏi tài khoản của bạn?");
}

</script>

</body>
</html>